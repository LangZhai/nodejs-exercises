$(function(){var e=$("#template_figure"),t=$("#template_li"),f=$("body>article"),o=$(">section",f),n=$(">aside>section",f),s=$(">ul",n),a=$("body>footer"),r=$(">p>output",a),i=$(),c=.5*f.width(),d=.5*f.height(),l=function(e,t){var f,o=i.parent(),n=o.children(),s=i.position();i.css({left:s.left+t.offsetX-e.offsetX,top:s.top+t.offsetY-e.offsetY}),f=[8,.2*n.length].concat($.map(n,function(e){var t=$(e),f=t.position();return[c-f.left,d-f.top,t.width(),t.height()]})).join(","),r.eq(o.index()).text(f).end().next().attr("href","/frames/save/?txt="+f)};o.on({dragstart:function(e){i.data("offset",{offsetX:e.offsetX,offsetY:e.offsetY})},dragend:function(e){l(i.data("offset"),{offsetX:e.offsetX,offsetY:e.offsetY})}},">figure.curr"),n.on("click",function(){var e=$(this);e.add(o.eq(e.index())).addClass("curr").siblings().removeClass("curr")}),s.on("click",">li",function(){var e=$(this),t=o.eq(e.parent().parent().index());i=t.children(":eq("+e.index()+")"),e.add(i).add(t).addClass("curr").siblings().removeClass("curr")}),a.on("change","input[type=file]",function(f){var n=$(this).parent().index(),a=Array.from(f.target.files).map(function(e){return{src:window.URL.createObjectURL(e),name:e.name}});return a.length%5!==0?(alert("请完整选择5个方向的图片！"),void $(this).val("")):(o.eq(n).html(e.template(a)),void s.eq(n).html(t.template(a)))}),$(document).on("keydown",function(e){if(i.length)switch(e.keyCode){case 37:e.preventDefault(),l({offsetX:0,offsetY:0},{offsetX:-1,offsetY:0});break;case 38:e.preventDefault(),l({offsetX:0,offsetY:0},{offsetX:0,offsetY:-1});break;case 39:e.preventDefault(),l({offsetX:0,offsetY:0},{offsetX:1,offsetY:0});break;case 40:e.preventDefault(),l({offsetX:0,offsetY:0},{offsetX:0,offsetY:1})}})});