$(function(){var e=ZLTemplate("#template_figure"),t=ZLTemplate("#template_li"),f=$("body>article"),o=$(">section",f),n=$(">aside>section>ul",f),a=$("body>footer"),s=$(">p>output",a),r=$(),i=[],c=0,l=function(e,t){var f,o=r.position();r.css({left:o.left+t.offsetX-e.offsetX,top:o.top+t.offsetY-e.offsetY}),f=$.map(r.parent().children(),function(e){return $(e).position()}),f.length&&s.text([f[1].left-f[0].left,f[1].top-f[0].top])};o.on({dragstart:function(e){r.data("offset",{offsetX:e.offsetX,offsetY:e.offsetY})},dragend:function(e){l(r.data("offset"),{offsetX:e.offsetX,offsetY:e.offsetY})}},">figure.curr"),n.on("click",">li",function(){var e=$(this);r=o.children(":eq("+e.index()+")"),e.add(r).addClass("curr").siblings().removeClass("curr")}),a.on("change","input[type=file]",function(f){var a=$(this).parent().index(),s=o.children(":eq("+a+")");c=0,i[a]=Array.prototype.map.call(f.target.files,function(e){return{src:window.URL.createObjectURL(e),name:e.name}}),i[a].length&&(s.length?(s.replaceWith(e.template(i[a][c])),n.children(":eq("+a+")").replaceWith(t.template(i[a][c]))):(o.append(e.template(i[a][c])),n.append(t.template(i[a][c]))))}),$(document).on("keydown",function(e){if(r.length)switch(e.keyCode){case 37:e.preventDefault(),l({offsetX:0,offsetY:0},{offsetX:-1,offsetY:0});break;case 38:e.preventDefault(),l({offsetX:0,offsetY:0},{offsetX:0,offsetY:-1});break;case 39:e.preventDefault(),l({offsetX:0,offsetY:0},{offsetX:1,offsetY:0});break;case 40:e.preventDefault(),l({offsetX:0,offsetY:0},{offsetX:0,offsetY:1})}}),setInterval(function(){i.forEach(function(e,t){var f=o.children(":eq("+t+")"),n=f.children("img"),a=f.children("figcaption");e[c]?(n.prop("src",e[c].src),a.text(e[c].name)):(n.prop("src",""),a.text(""))}),c++,c===Math.max.apply(null,i.map(function(e){return e.length}))&&(c=0)},85)});