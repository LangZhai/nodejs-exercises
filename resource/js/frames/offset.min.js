$(function(){var e=ZLTemplate("#template_figure"),t=ZLTemplate("#template_li"),f=$("body>article"),o=$(">section",f),s=$(">aside>section>ul",f),n=$("body>footer"),a=$(">p>output",n),i=$(),r=function(e,t){var f,o=i.position();i.css({left:o.left+t.offsetX-e.offsetX,top:o.top+t.offsetY-e.offsetY}),f=$.map(i.parent().children(),function(e){return $(e).position()}),f.length&&a.text([f[1].left-f[0].left,f[1].top-f[0].top])};o.on({dragstart:function(e){i.data("offset",{offsetX:e.offsetX,offsetY:e.offsetY})},dragend:function(e){r(i.data("offset"),{offsetX:e.offsetX,offsetY:e.offsetY})}},">figure.curr"),s.on("click",">li",function(){var e=$(this);i=o.children(":eq("+e.index()+")"),e.add(i).addClass("curr").siblings().removeClass("curr")}),n.on("change","input[type=file]",function(f){var n=$(this).parent().index(),a=f.target.files[0]?{src:window.URL.createObjectURL(f.target.files[0]),name:f.target.files[0].name}:null,i=o.children(":eq("+n+")");a&&(i.length?(i.replaceWith(e.template(a)),s.children(":eq("+n+")").replaceWith(t.template(a))):(o.append(e.template(a)),s.append(t.template(a))))}),$(document).on("keydown",function(e){if(i.length)switch(e.keyCode){case 37:e.preventDefault(),r({offsetX:0,offsetY:0},{offsetX:-1,offsetY:0});break;case 38:e.preventDefault(),r({offsetX:0,offsetY:0},{offsetX:0,offsetY:-1});break;case 39:e.preventDefault(),r({offsetX:0,offsetY:0},{offsetX:1,offsetY:0});break;case 40:e.preventDefault(),r({offsetX:0,offsetY:0},{offsetX:0,offsetY:1})}})});